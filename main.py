import asyncio
import hashlib
import json
import os
from typing import Dict, Optional

import aiohttp
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse, PlainTextResponse

from aiogram import F, Router
from aiogram.client.bot import Bot
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    FSInputFile,
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from aiogram.dispatcher.dispatcher import Dispatcher

# ========= –ù–ê–°–¢–†–û–ô–ö–ò =========

# –¢–æ–∫–µ–Ω ‚Äî –ø–æ —Ç–≤–æ–µ–π –ø—Ä–æ—Å—å–±–µ –∂—ë—Å—Ç–∫–æ –≤ –∫–æ–¥–µ
TOKEN = "8402271440:AAH_76pBTaHSD-q7T8I4TG1ZP1qqrSyTkA0"

# –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
DISPATCHER_TG = "zhelektown"  # –Ω–∏–∫ –±–µ–∑ @ (–ø—Ä–æ–≤–µ—Ä—å –∏ –ø–æ–ø—Ä–∞–≤—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
DISPATCHER_PHONE = "+79340241414"

# –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è –≤–µ–±—Ö—É–∫–∞ (—á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è)
WEBHOOK_BASE = os.getenv("WEBHOOK_BASE", "").strip()  # –Ω–∞–ø—Ä–∏–º–µ—Ä: https://bot.example.com
WEBHOOK_SECRET = os.getenv("WEBHOOK_SECRET", "").strip()  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ —Å–≥–µ–Ω–µ—Ä–∏–º

# –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø–æ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂—É (–µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ñ–∏–∫—Å-—Ç–∞—Ä–∏—Ñ–æ–≤)
# –¢–∞—Ä–∏—Ñ—ã –†–£–ë/–ö–ú ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è.
RATES_PER_KM = {
    "–ª–µ–≥–∫–æ–≤–æ–π": 25,
    "–∫–∞–º—Ä–∏": 35,
    "–º–∏–Ω–∏–≤—ç–Ω": 45,
}

# ========= –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –¢–ê–†–ò–§–´ (–ì–û–†–û–î–ê) =========
# –ö–ª—é—á–∏ ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ (—Å—Ç—Ä–æ—á–Ω—ã–µ, –¥–µ—Ñ–∏—Å—ã/–ø—Ä–æ–±–µ–ª—ã –∫–∞–∫ –æ–±—ã—á–Ω–æ).
FIXED_PRICES: Dict[str, Dict[str, int]] = {
    # –ö–ú–í –±–∞–∑–æ–≤—ã–µ
    "–∂–µ–ª–µ–∑–Ω–æ–≤–æ–¥—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 800, "–∫–∞–º—Ä–∏": 1500, "–º–∏–Ω–∏–≤—ç–Ω": 2000},
    "–ø—è—Ç–∏–≥–æ—Ä—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 1200, "–∫–∞–º—Ä–∏": 1500, "–º–∏–Ω–∏–≤—ç–Ω": 1900},
    "–µ—Å—Å–µ–Ω—Ç—É–∫–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 1300, "–∫–∞–º—Ä–∏": 2000, "–º–∏–Ω–∏–≤—ç–Ω": 2500},
    "–∫–∏—Å–ª–æ–≤–æ–¥—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 1800, "–∫–∞–º—Ä–∏": 2500, "–º–∏–Ω–∏–≤—ç–Ω": 3000},

    "–∞—Ä—Ö—ã–∑": {"–ª–µ–≥–∫–æ–≤–æ–π": 6500, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–∞—Ä—Ö—ã–∑ —Ä–æ–º–∞–Ω—Ç–∏–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 7000, "–∫–∞–º—Ä–∏": 9000, "–º–∏–Ω–∏–≤—ç–Ω": 11000},
    "–¥–æ–º–±–∞–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 6500, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–∞–∑–∞—É": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 9000},
    "—Ç–µ—Ä—Å–∫–æ–ª": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 9000},
    "—ç–ª—å–±—Ä—É—Å": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "—Ç–µ–±–µ—Ä–¥–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "–Ω–µ–π—Ç—Ä–∏–Ω–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 5000, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "—Ç–µ–≥–µ–Ω–µ–∫–ª–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 5000, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "–±–∞–π–¥–∞–µ–≤–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 5000, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "—á–µ–≥–µ—Ç": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 9000},

    "—Å—Ç–∞–≤—Ä–æ–ø–æ–ª—å": {"–ª–µ–≥–∫–æ–≤–æ–π": 5400, "–∫–∞–º—Ä–∏": 7200, "–º–∏–Ω–∏–≤—ç–Ω": 9000},
    "—á–µ—Ä–∫–µ—Å—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 3000, "–∫–∞–º—Ä–∏": 4000, "–º–∏–Ω–∏–≤—ç–Ω": 5000},
    "–Ω–∞–ª—å—á–∏–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 3300, "–∫–∞–º—Ä–∏": 4400, "–º–∏–Ω–∏–≤—ç–Ω": 5500},
    "–≤–ª–∞–¥–∏–∫–∞–≤–∫–∞–∑": {"–ª–µ–≥–∫–æ–≤–æ–π": 6600, "–∫–∞–º—Ä–∏": 8800, "–º–∏–Ω–∏–≤—ç–Ω": 11000},
    "–≥—Ä–æ–∑–Ω—ã–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 9300, "–∫–∞–º—Ä–∏": 12400, "–º–∏–Ω–∏–≤—ç–Ω": 15500},
    "–Ω–∞–∑—Ä–∞–Ω—å": {"–ª–µ–≥–∫–æ–≤–æ–π": 6600, "–∫–∞–º—Ä–∏": 8800, "–º–∏–Ω–∏–≤—ç–Ω": 11000},
    "–∞–¥–ª–µ—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 17400, "–∫–∞–º—Ä–∏": 23200, "–º–∏–Ω–∏–≤—ç–Ω": 29000},

    "–∞–ª–∞–≥–∏—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 2100, "–∫–∞–º—Ä–∏": 2800, "–º–∏–Ω–∏–≤—ç–Ω": 3500},
    "–∞—Ä–¥–æ–Ω": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7400, "–º–∏–Ω–∏–≤—ç–Ω": 9200},
    "–∞—Ä–∑–≥–∏—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–∞—Ä–º–∞–≤–∏—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 5700, "–∫–∞–º—Ä–∏": 7600, "–º–∏–Ω–∏–≤—ç–Ω": 9500},
    "–∞—Å—Ç—Ä–∞—Ö–∞–Ω—å": {"–ª–µ–≥–∫–æ–≤–æ–π": 18900, "–∫–∞–º—Ä–∏": 25000, "–º–∏–Ω–∏–≤—ç–Ω": 31500},
    "–∞—É—à–∏–≥–µ—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 4000, "–∫–∞–º—Ä–∏": 5400, "–º–∏–Ω–∏–≤—ç–Ω": 6700},
    "–∞—á–∏–∫—É–ª–∞–∫ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 5500, "–∫–∞–º—Ä–∏": 7400, "–º–∏–Ω–∏–≤—ç–Ω": 9200},
    "–±–∞–∫—Å–∞–Ω": {"–ª–µ–≥–∫–æ–≤–æ–π": 2500, "–∫–∞–º—Ä–∏": 3300, "–º–∏–Ω–∏–≤—ç–Ω": 4000},
    "–±–∞—Ç—É–º–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 30000, "–∫–∞–º—Ä–∏": 40000, "–º–∏–Ω–∏–≤—ç–Ω": 50000},
    "–±–µ–ª–æ–º–µ—á–µ—Ç—Å–∫–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 3600, "–∫–∞–º—Ä–∏": 4800, "–º–∏–Ω–∏–≤—ç–Ω": 6000},
    "–±–µ—Å–ª–∞–Ω": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 4000, "–∫–∞–º—Ä–∏": 5400, "–º–∏–Ω–∏–≤—ç–Ω": 6700},
    "–±—É–¥—ë–Ω–æ–≤—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 4000, "–∫–∞–º—Ä–∏": 5400, "–º–∏–Ω–∏–≤—ç–Ω": 6700},
    "–≤–∏—Ç—è–∑–µ–≤–æ –ø–æ—Å–µ–ª–æ–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 18000, "–∫–∞–º—Ä–∏": 24000, "–º–∏–Ω–∏–≤—ç–Ω": 30000},
    "–≤–æ–ª–≥–æ–≥—Ä–∞–¥": {"–ª–µ–≥–∫–æ–≤–æ–π": 18000, "–∫–∞–º—Ä–∏": 24000, "–º–∏–Ω–∏–≤—ç–Ω": 30000},
    "–≥–∞–ª—é–≥–∞–µ–≤—Å–∫–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–≥–µ–ª–µ–Ω–¥–∂–∏–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 18000, "–∫–∞–º—Ä–∏": 24000, "–º–∏–Ω–∏–≤—ç–Ω": 30000},
    "–≥–µ–æ—Ä–≥–∏–µ–≤—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 1300, "–∫–∞–º—Ä–∏": 2000, "–º–∏–Ω–∏–≤—ç–Ω": 2500},
    "–≥–æ—Ä–Ω–æ–∑–∞–≤–æ–¥—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3000, "–∫–∞–º—Ä–∏": 4000, "–º–∏–Ω–∏–≤—ç–Ω": 5000},
    "–≥—Ä—É—à–µ–≤—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3300, "–∫–∞–º—Ä–∏": 4400, "–º–∏–Ω–∏–≤—ç–Ω": 5500},
    "–≥—É–¥–∞—É—Ä–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 15000, "–∫–∞–º—Ä–∏": 20000, "–º–∏–Ω–∏–≤—ç–Ω": 25000},
    "–¥–µ—Ä–±–µ–Ω—Ç": {"–ª–µ–≥–∫–æ–≤–æ–π": 18000, "–∫–∞–º—Ä–∏": 24000, "–º–∏–Ω–∏–≤—ç–Ω": 30000},
    "–¥–∂—É–±–≥–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 14000, "–∫–∞–º—Ä–∏": 19000, "–º–∏–Ω–∏–≤—ç–Ω": 23000},
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": {"–ª–µ–≥–∫–æ–≤–æ–π": 72000, "–∫–∞–º—Ä–∏": 96000, "–º–∏–Ω–∏–≤—ç–Ω": 120000},
    "–µ–ª–∏–∑–∞–≤–µ—Ç–∏–Ω—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3700, "–∫–∞–º—Ä–∏": 5000, "–º–∏–Ω–∏–≤—ç–Ω": 6200},
    "–∑–µ–ª–µ–Ω–æ–∫—É–º—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 2400, "–∫–∞–º—Ä–∏": 3200, "–º–∏–Ω–∏–≤—ç–Ω": 4000},
    "–∑–µ–ª–µ–Ω—á—É–∫—Å–∫–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 5000, "–∫–∞–º—Ä–∏": 7500, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "–∑–æ–ª—å—Å–∫–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 1500, "–∫–∞–º—Ä–∏": 2000, "–º–∏–Ω–∏–≤—ç–Ω": 2500},
    "–∏–∫–æ–Ω—Ö–∞–ª–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 3400, "–∫–∞–º—Ä–∏": 4500, "–º–∏–Ω–∏–≤—ç–Ω": 5600},
    "–∫–∞–±–∞—Ä–¥–∏–Ω–∫–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 16500, "–∫–∞–º—Ä–∏": 22000, "–º–∏–Ω–∏–≤—ç–Ω": 27500},
    "–∫–∞–º–∞—Ç–∞ —Å–µ–ª–æ (–æ—Å–µ—Ç–∏—è)": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "–∫–∞—Ä—á–∞–µ–≤—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 4600, "–∫–∞–º—Ä–∏": 6100, "–º–∏–Ω–∏–≤—ç–Ω": 7700},
    "–∫–∞—Ä–∞—Ç—é–±–µ": {"–ª–µ–≥–∫–æ–≤–æ–π": 5400, "–∫–∞–º—Ä–∏": 7200, "–º–∏–Ω–∏–≤—ç–Ω": 9000},
    "–∫–∞—Å–ø–∏–π—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 14500, "–∫–∞–º—Ä–∏": 19000, "–º–∏–Ω–∏–≤—ç–Ω": 24000},
    "–∫–∏–∑–ª—è—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 11400, "–∫–∞–º—Ä–∏": 15200, "–º–∏–Ω–∏–≤—ç–Ω": 19000},
    "–∫–æ—á—É–±–µ–µ–≤—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3700, "–∫–∞–º—Ä–∏": 5000, "–º–∏–Ω–∏–≤—ç–Ω": 6200},
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 12000, "–∫–∞–º—Ä–∏": 16000, "–º–∏–Ω–∏–≤—ç–Ω": 20000},
    "–∫—É—Ä—Å–∫–∞—è": {"–ª–µ–≥–∫–æ–≤–æ–π": 4300, "–∫–∞–º—Ä–∏": 5700, "–º–∏–Ω–∏–≤—ç–Ω": 7100},
    "–ª–∞–±–∏–Ω—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 7000, "–∫–∞–º—Ä–∏": 9300, "–º–∏–Ω–∏–≤—ç–Ω": 11600},
    "–ª–∞–∑–∞—Ä–µ–≤—Å–∫–æ–µ": {"–ª–µ–≥–∫–æ–≤–æ–π": 14500, "–∫–∞–º—Ä–∏": 19200, "–º–∏–Ω–∏–≤—ç–Ω": 24000},
    "–ª–µ–≤–æ–∫—É–º—Å–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 5200, "–∫–∞–º—Ä–∏": 7000, "–º–∏–Ω–∏–≤—ç–Ω": 8700},
    "–º–∞–≥–∞—Å": {"–ª–µ–≥–∫–æ–≤–æ–π": 6600, "–∫–∞–º—Ä–∏": 8800, "–º–∏–Ω–∏–≤—ç–Ω": 11000},
    "–º–∞–π–∫–æ–ø": {"–ª–µ–≥–∫–æ–≤–æ–π": 8800, "–∫–∞–º—Ä–∏": 11700, "–º–∏–Ω–∏–≤—ç–Ω": 14500},
    "–º–∞–π—Å–∫–∏–π –∫–±—Ä": {"–ª–µ–≥–∫–æ–≤–æ–π": 4300, "–∫–∞–º—Ä–∏": 5700, "–º–∏–Ω–∏–≤—ç–Ω": 7000},
    "–º–∞—Ä—å–∏–Ω—Å–∫–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 2100, "–∫–∞–º—Ä–∏": 2800, "–º–∏–Ω–∏–≤—ç–Ω": 3500},
    "–º–∞—Ö–∞—á–∫–∞–ª–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 13900, "–∫–∞–º—Ä–∏": 18500, "–º–∏–Ω–∏–≤—ç–Ω": 23100},
    "–º–æ–∑–¥–æ–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 4900, "–∫–∞–º—Ä–∏": 6500, "–º–∏–Ω–∏–≤—ç–Ω": 8100},
    "–Ω–∞—Ä—Ç–∫–∞–ª–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 3700, "–∫–∞–º—Ä–∏": 5000, "–º–∏–Ω–∏–≤—ç–Ω": 6200},
    "–Ω–µ–≤–∏–Ω–Ω–æ–º—ã—Å—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 3000, "–∫–∞–º—Ä–∏": 4000, "–º–∏–Ω–∏–≤—ç–Ω": 5000},
    "–Ω–µ–∑–ª–æ–±–Ω–∞—è —Å—Ç–∞–Ω–∏—Ü–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 1500, "–∫–∞–º—Ä–∏": 2000, "–º–∏–Ω–∏–≤—ç–Ω": 2500},
    "–Ω–µ—Ñ—Ç–µ–∫—É–º—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 6400, "–∫–∞–º—Ä–∏": 8500, "–º–∏–Ω–∏–≤—ç–Ω": 10700},
    "–Ω–æ–≤–æ–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 7400, "–∫–∞–º—Ä–∏": 9800, "–º–∏–Ω–∏–≤—ç–Ω": 12200},
    "–Ω–æ–≤–æ–ø–∞–≤–ª–æ–≤—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 2500, "–∫–∞–º—Ä–∏": 3400, "–º–∏–Ω–∏–≤—ç–Ω": 4200},
    "–Ω–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 17000, "–∫–∞–º—Ä–∏": 22600, "–º–∏–Ω–∏–≤—ç–Ω": 28200},
    "–Ω–æ–≤–æ—Å–µ–ª–∏—Ü–∫–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3000, "–∫–∞–º—Ä–∏": 4000, "–º–∏–Ω–∏–≤—ç–Ω": 5000},
    "–ø—Ä–æ—Ö–ª–∞–¥–Ω—ã–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 3600, "–∫–∞–º—Ä–∏": 4800, "–º–∏–Ω–∏–≤—ç–Ω": 6000},
    "–ø—Å–µ–±–∞–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 9000, "–∫–∞–º—Ä–∏": 12000, "–º–∏–Ω–∏–≤—ç–Ω": 15000},
    "–ø—Å—ã–≥–∞–Ω—Å—É —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 3900, "–∫–∞–º—Ä–∏": 5200, "–º–∏–Ω–∏–≤—ç–Ω": 6500},
    "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É": {"–ª–µ–≥–∫–æ–≤–æ–π": 16000, "–∫–∞–º—Ä–∏": 21000, "–º–∏–Ω–∏–≤—ç–Ω": 26000},
    "—Å–≤–µ—Ç–ª–æ–≥—Ä–∞–¥": {"–ª–µ–≥–∫–æ–≤–æ–π": 5100, "–∫–∞–º—Ä–∏": 6800, "–º–∏–Ω–∏–≤—ç–Ω": 8500},
    "—Å–æ—á–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 16500, "–∫–∞–º—Ä–∏": 22000, "–º–∏–Ω–∏–≤—ç–Ω": 27500},
    "—Å—Ç–µ–ø–∞–Ω—Ü–º–∏–Ω–¥–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 13000, "–∫–∞–º—Ä–∏": 17000, "–º–∏–Ω–∏–≤—ç–Ω": 22000},
    "—Å—Ç–µ–ø–Ω–æ–µ —Å–µ–ª–æ": {"–ª–µ–≥–∫–æ–≤–æ–π": 4400, "–∫–∞–º—Ä–∏": 5800, "–º–∏–Ω–∏–≤—ç–Ω": 7300},
    "—Å—É–Ω–∂–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 7500, "–∫–∞–º—Ä–∏": 10000, "–º–∏–Ω–∏–≤—ç–Ω": 12500},
    "—Ç–±–∏–ª–∏—Å–∏": {"–ª–µ–≥–∫–æ–≤–æ–π": 20000, "–∫–∞–º—Ä–∏": 25000, "–º–∏–Ω–∏–≤—ç–Ω": 30000},
    "—Ç–µ—Ä–µ–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 4700, "–∫–∞–º—Ä–∏": 6200, "–º–∏–Ω–∏–≤—ç–Ω": 7800},
    "—Ç—É–∞–ø—Å–µ": {"–ª–µ–≥–∫–æ–≤–æ–π": 13000, "–∫–∞–º—Ä–∏": 17300, "–º–∏–Ω–∏–≤—ç–Ω": 21700},
    "—É—Ä—É—Å-–º–∞—Ä—Ç–∞–Ω": {"–ª–µ–≥–∫–æ–≤–æ–π": 9000, "–∫–∞–º—Ä–∏": 12000, "–º–∏–Ω–∏–≤—ç–Ω": 15000},
    "—É—á–∫—É–ª–∞–Ω –∞—É–ª": {"–ª–µ–≥–∫–æ–≤–æ–π": 6000, "–∫–∞–º—Ä–∏": 8000, "–º–∏–Ω–∏–≤—ç–Ω": 10000},
    "—Ö–∞–¥—ã–∂–µ–Ω—Å–∫": {"–ª–µ–≥–∫–æ–≤–æ–π": 10700, "–∫–∞–º—Ä–∏": 14200, "–º–∏–Ω–∏–≤—ç–Ω": 17800},
    "—Ö–∞—Å–∞–≤—é—Ä—Ç": {"–ª–µ–≥–∫–æ–≤–æ–π": 11400, "–∫–∞–º—Ä–∏": 15200, "–º–∏–Ω–∏–≤—ç–Ω": 19000},
    "—Ö—É—Ä–∑—É–∫ –∞—É–ª": {"–ª–µ–≥–∫–æ–≤–æ–π": 6500, "–∫–∞–º—Ä–∏": 9000, "–º–∏–Ω–∏–≤—ç–Ω": 11500},
    "—Ü–µ–π": {"–ª–µ–≥–∫–æ–≤–æ–π": 7300, "–∫–∞–º—Ä–∏": 9700, "–º–∏–Ω–∏–≤—ç–Ω": 12000},
    "—ç–ª–∏—Å—Ç–∞": {"–ª–µ–≥–∫–æ–≤–æ–π": 9400, "–∫–∞–º—Ä–∏": 12500, "–º–∏–Ω–∏–≤—ç–Ω": 15600},
}

# ========= –£–¢–ò–õ–ò–¢–´ =========

def norm_city(s: str) -> str:
    return " ".join(s.strip().lower().replace("—ë", "–µ").replace("  ", " ").split())

def get_fixed_price(city: str, car_key: str) -> Optional[int]:
    city_key = norm_city(city)
    data = FIXED_PRICES.get(city_key)
    if not data:
        return None
    return data.get(car_key)

async def geocode_nominatim(session: aiohttp.ClientSession, query: str) -> Optional[tuple[float, float]]:
    """
    –ü—Ä–æ—Å—Ç–æ–π –≥–µ–æ–∫–æ–¥–µ—Ä –Ω–∞ Nominatim (–ø—É–±–ª–∏—á–Ω—ã–π).
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (lat, lon) –∏–ª–∏ None.
    """
    url = "https://nominatim.openstreetmap.org/search"
    params = {"format": "json", "q": query, "limit": 1, "accept-language": "ru"}
    headers = {"User-Agent": "kmv-transfer-bot/1.0"}
    try:
        async with session.get(url, params=params, headers=headers, timeout=15) as r:
            if r.status != 200:
                return None
            payload = await r.json()
            if not payload:
                return None
            lat = float(payload[0]["lat"])
            lon = float(payload[0]["lon"])
            return (lat, lon)
    except Exception:
        return None

async def route_distance_km(session: aiohttp.ClientSession, start: str, finish: str) -> Optional[int]:
    """
    –°—á–∏—Ç–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ –¥–æ—Ä–æ–≥–µ —Å –ø–æ–º–æ—â—å—é OSRM (–ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä),
    –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ —Ç–æ—á–∫–∏.
    """
    p1 = await geocode_nominatim(session, start)
    p2 = await geocode_nominatim(session, finish)
    if not p1 or not p2:
        return None
    (lat1, lon1), (lat2, lon2) = p1, p2
    # OSRM –∂–¥—ë—Ç lon,lat
    url = f"https://router.project-osrm.org/route/v1/driving/{lon1},{lat1};{lon2},{lat2}"
    params = {"overview": "false"}
    try:
        async with session.get(url, params=params, timeout=20) as r:
            if r.status != 200:
                return None
            data = await r.json()
            routes = data.get("routes") or []
            if not routes:
                return None
            dist_m = routes[0].get("distance", 0)
            km = int(round(dist_m / 1000))
            return km if km > 0 else None
    except Exception:
        return None

def compute_by_rates(km: int, car_key: str) -> int:
    rate = RATES_PER_KM.get(car_key, 30)
    return int(km * rate)

def main_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å", callback_data="calc")],
            [InlineKeyboardButton(text="üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É", url=f"https://t.me/{DISPATCHER_TG}")],
            [
                InlineKeyboardButton(text="üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É", url=f"tel:{DISPATCHER_PHONE}"),
                InlineKeyboardButton(text="üìã –¢–µ–ª–µ—Ñ–æ–Ω –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞", callback_data="show_phone"),
            ],
        ]
    )

def car_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="–õ–µ–≥–∫–æ–≤–æ–π", callback_data="car_–ª–µ–≥–∫–æ–≤–æ–π"),
                InlineKeyboardButton(text="–ö–∞–º—Ä–∏", callback_data="car_–∫–∞–º—Ä–∏"),
                InlineKeyboardButton(text="–ú–∏–Ω–∏–≤—ç–Ω", callback_data="car_–º–∏–Ω–∏–≤—ç–Ω"),
            ],
            [InlineKeyboardButton(text="‚Ü©Ô∏è –°–Ω–∞—á–∞–ª–∞", callback_data="calc_restart")],
        ]
    )

# ========= FSM =========

class Calc(StatesGroup):
    waiting_from = State()
    waiting_to = State()
    waiting_car = State()

# ========= AIOGRAM –ò FASTAPI =========

router = Router()
storage = MemoryStorage()
bot = Bot(TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=storage)
dp.include_router(router)

app = FastAPI()


# ------- –•–≠–ù–î–õ–ï–†–´ -------

@router.message(CommandStart())
async def on_start(message: Message):
    txt = (
        "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n"
        "–Ø –ø–æ–º–æ–≥—É —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞ –∏–∑/–≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç –ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã –∏ –ø–æ –ö–ú–í.\n\n"
        "–ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
    )
    await message.answer(txt, reply_markup=main_menu_kb())


@router.callback_query(F.data == "show_phone")
async def show_phone(cb: CallbackQuery):
    await cb.answer(DISPATCHER_PHONE, show_alert=True)


@router.callback_query(F.data == "calc")
async def calc_begin(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(Calc.waiting_from)
    await cb.message.answer("üèÅ –í–≤–µ–¥–∏—Ç–µ <b>–ø—É–Ω–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b> (–≥–æ—Ä–æ–¥/–ø–æ—Å—ë–ª–æ–∫):")
    await cb.answer()


@router.message(Calc.waiting_from)
async def calc_from(message: Message, state: FSMContext):
    await state.update_data(from_city=message.text.strip())
    await state.set_state(Calc.waiting_to)
    await message.answer("üìç –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>–ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</b>:")


@router.message(Calc.waiting_to)
async def calc_to(message: Message, state: FSMContext):
    await state.update_data(to_city=message.text.strip())
    await state.set_state(Calc.waiting_car)
    await message.answer("üöò –í—ã–±–µ—Ä–∏—Ç–µ <b>–∫–ª–∞—Å—Å –∞–≤—Ç–æ</b>:", reply_markup=car_kb())


@router.callback_query(F.data == "calc_restart")
async def calc_restart(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(Calc.waiting_from)
    await cb.message.answer("üèÅ –î–∞–≤–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ. –í–≤–µ–¥–∏—Ç–µ <b>–ø—É–Ω–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b>:")
    await cb.answer()


@router.callback_query(F.data.startswith("car_"))
async def calc_car(cb: CallbackQuery, state: FSMContext):
    car_key = cb.data.split("_", 1)[1]  # '–ª–µ–≥–∫–æ–≤–æ–π' | '–∫–∞–º—Ä–∏' | '–º–∏–Ω–∏–≤—ç–Ω'
    await state.update_data(car=car_key)
    data = await state.get_data()
    from_city = data.get("from_city", "").strip()
    to_city = data.get("to_city", "").strip()

    # –°–Ω–∞—á–∞–ª–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ –ø–æ –ø—É–Ω–∫—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    price = get_fixed_price(to_city, car_key)
    details = ""
    if price is None:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ—Å—á–∏—Ç–∞—Ç—å –ø–æ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂—É
        async with aiohttp.ClientSession() as session:
            km = await route_distance_km(session, from_city, to_city)
        if km is not None:
            price = compute_by_rates(km, car_key)
            details = f"\nüìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ~{km} –∫–º"
        else:
            price = None

    disclaimer = "‚ö†Ô∏è <i>–¶–µ–Ω—ã —è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–º–∏, –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º.</i>\n"

    if price is not None:
        text = (
            f"{disclaimer}"
            f"–ú–∞—Ä—à—Ä—É—Ç: <b>{from_city}</b> ‚Üí <b>{to_city}</b>\n"
            f"–ö–ª–∞—Å—Å –∞–≤—Ç–æ: <b>{car_key.capitalize()}</b>\n"
            f"üí∞ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <b>{price} ‚ÇΩ</b>{details}"
        )
    else:
        text = (
            f"{disclaimer}"
            f"–ú–∞—Ä—à—Ä—É—Ç: <b>{from_city}</b> ‚Üí <b>{to_city}</b>\n"
            f"–ö–ª–∞—Å—Å –∞–≤—Ç–æ: <b>{car_key.capitalize()}</b>\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É."
        )

    await cb.message.answer(text, reply_markup=main_menu_kb())
    await cb.answer()
    await state.clear()


# ------- FASTAPI –†–û–£–¢–´ –î–õ–Ø –í–ï–ë–•–£–ö–ê -------

def make_webhook_path(token: str) -> str:
    if WEBHOOK_SECRET:
        suffix = WEBHOOK_SECRET.strip()
    else:
        # –ì–µ–Ω–µ—Ä–∏–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ‚Äú—Å–µ–∫—Ä–µ—Ç‚Äù –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º –≥–æ–ª—ã–π —Ç–æ–∫–µ–Ω)
        suffix = hashlib.sha256(token.encode()).hexdigest()[:32]
    return f"/webhook/{suffix}"

WEBHOOK_PATH = make_webhook_path(TOKEN)


@app.on_event("startup")
async def on_startup():
    if not WEBHOOK_BASE:
        # –ó–∞–ø—É—Å—Ç–∏–º—Å—è –±–µ–∑ –≤–µ–±—Ö—É–∫–∞ (–º–æ–∂–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–∑–∂–µ)
        print("WARNING:WEBHOOK_BASE –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –≤–µ–±—Ö—É–∫ –Ω–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£–∫–∞–∂–∏ WEBHOOK_BASE.")
        return
    url = WEBHOOK_BASE.rstrip("/") + WEBHOOK_PATH
    try:
        await bot.set_webhook(url)
        print(f"Webhook set: {url}")
    except Exception as e:
        print(f"Failed set webhook: {e}")


@app.on_event("shutdown")
async def on_shutdown():
    try:
        await bot.delete_webhook(drop_pending_updates=False)
    except Exception:
        pass
    await bot.session.close()


@app.get("/health")
async def health():
    return PlainTextResponse("ok")


@app.post(WEBHOOK_PATH)
async def telegram_webhook(request: Request):
    body = await request.json()
    update = bot._parse_update(body)  # –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–∞—Ä—Å–µ—Ä aiogram
    await dp.feed_update(bot, update)
    return JSONResponse({"status": "ok"})


# ------- –õ–û–ö–ê–õ–¨–ù–´–ô –°–¢–ê–†–¢ (–¥–ª—è docker/cmd) -------

if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=int(os.getenv("PORT", "8000")),
        reload=False,
    )
